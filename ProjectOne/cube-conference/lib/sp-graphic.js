(function(a){var b=Math.floor,c=Math.PI,d=Math.abs,f=Math.max,g=Math.min;let e=function(a){return h[a]()},h=[function(){let a={};return a={CLEAR:0,UNDO:1,REDO:2,PEN:3,RECT:4,TEXT:5,ELLIPSE:6,ARROW:7,MOSAIC:8,CROP:9,IMAGE:10},a},function(){return{Graphic:class{constructor(a=2,b='#FF0000'){this.size=a,this.color=b,this.cursor='default'}open(a){this.onOpen(a.viewctx,a.draftctx,a)}close(a){this.onmousedown=()=>{},this.onmousemove=()=>{},this.onmouseup=()=>{},this.onClose(a)}restore(){}onOpen(){}onClose(){}onmousedown(){}onmousemove(){}onmouseup(){}triggerEvent(a,b,c,d){this[a](b,c,d)}setSize(a){this.size=a}setColor(a){this.color=a}}}},function(){let a=e(0),{Graphic:b}=e(1);class c extends b{onOpen(b,d,e){let f=null;this.onmousedown=(b,c)=>{f={cmd:a.PEN,zoom:1,color:this.color,size:this.size,points:[{x:b,y:c}]}},this.onmousemove=(a,d)=>{null!==f&&(f.points.push({x:a,y:d}),c.Draw(b,f,e.ratio,f.points.length-2))},this.onmouseup=()=>{null!==f&&(e.change(f),f=null)}}onClose(){}static Draw(a,b,c,d=0){c*=b.zoom;let e=b.points,f=e[d],g=e.length;a.strokeStyle=b.color,a.lineWidth=b.size*c,a.lineCap='round',a.beginPath(),a.moveTo(f.x*c,f.y*c);for(let f,h=d+1;h<g;h++)f=e[h],a.lineTo(f.x*c,f.y*c);a.stroke()}}return{Pen:c}},function(){let a=e(0),{Graphic:b}=e(1);class c extends b{onOpen(b,d,e){let f=null;this.onmousedown=(b,c)=>{f={cmd:a.RECT,zoom:1,color:this.color,size:this.size,x:b,y:c,width:0,height:0}},this.onmousemove=(a,b)=>{null!==f&&(f.width=a-f.x,f.height=b-f.y,e.clear(!1),c.Draw(d,f,e.ratio))},this.onmouseup=()=>{null!==f&&(e.clear(!1),c.Draw(b,f,e.ratio),e.change(f),f=null)}}onClose(){}static Draw(a,b,c){c*=b.zoom,a.strokeStyle=b.color,a.lineWidth=b.size*c,a.strokeRect(b.x*c,b.y*c,b.width*c,b.height*c)}}return{Rect:c}},function(){let a=e(0),{Graphic:b}=e(1);class c extends b{constructor(a,b){super(a,b),this.size=14,this.fontFamily='Microsoft YaHei',this.cursor='text',this.dom=null}onOpen(b,d,e){let h=null;this.onmouseup=(d,i)=>{if(null===this.dom){let b=e.getBounds(1,!0),c=b.x+b.width,j=b.y+b.height;h={cmd:a.TEXT,zoom:1,text:'',x:d,y:g(i,j-(this.size+7)-1),color:this.color,size:this.size,family:this.fontFamily,offset:7};let k=120,l=c-d-1,m=h.size+7,n=document.createElement('div');n.setAttribute('contenteditable','plaintext-only'),n.style.position='absolute',n.style.outline='1px dashed #666666',n.style.boxShadow='0 0 15px rgba(0, 0, 0, 0.4)',n.style.zIndex='1001',n.style.backgroundColor='rgba(255, 255, 255, 0.5)',n.style.fontFamily=h.family+', "\u9ED1\u4F53", Arial, Helvetica, sans-serif',n.style.fontSize=h.size+'px',n.style.color=h.color,n.style.lineHeight=m+'px',n.style.minHeight=m+'px',n.style.maxHeight=j-i-1+'px',n.style.wordBreak='break-all',n.style.overflow='hidden',n.style.left=d+'px',n.style.top=h.y+'px',k<l?(n.style.minWidth=k+'px',n.style.maxWidth=l+'px'):n.style.width=l+'px';let o=()=>7<n.scrollHeight-n.clientHeight;n.onscroll=()=>{0!==n.scrollTop&&(n.scrollTop=0)},n.oninput=()=>{if(o()){let a=document.getSelection().getRangeAt(0),b=a.endOffset;if(0<b){let c=a.endContainer,d=c.textContent,e=d.length,h=b+1,i=d.substr(0,h),j=10,k=d.substring(h-1,e);for(c.textContent=i.substr(0,g(j,h))+k;!o()&&j<h;)j=g(j+10,h),c.textContent=i.substr(0,j)+k;for(;o()&&0<j;)j=f(j-1,0),c.textContent=i.substr(0,j)+k;a.setStart(c,j),a.setEnd(c,j)}else document.execCommand('delete')}},e.wrap.appendChild(n),n.focus(),this.dom=n}else h.text=c.getString(this.dom),c.Draw(b,h,e.ratio),this.restore(),e.change(h),h=null}}onClose(){this.restore()}restore(){null!==this.dom&&(this.dom.onscroll=null,this.dom.oninput=null,this.dom.parentElement.removeChild(this.dom),this.dom=null)}setFontFamily(a){this.fontFamily=a}static getString(a){let b=document.createElement('form');b.style.visibility='hidden';let c=document.createElement('textarea');c.name='data',c.wrap='hard',c.style.cssText=a.style.cssText,c.style.padding='0',c.style.margin='0',c.style.border='none',c.style.width=a.clientWidth+1+'px',c.style.top='-100px',c.value=a.innerText,b.appendChild(c),document.body.appendChild(b);let d=new FormData(b),e=d.get('data');return document.body.removeChild(b),e}static Draw(a,b,c){c*=b.zoom;let d=b.size*c,e=b.offset*c;a.fillStyle=b.color,a.font=d+'px '+b.family+', "\u9ED1\u4F53", Arial, Helvetica, sans-serif';let f=b.text.split('\n'),g=e/2-d/(a=>{if(21===a)return 9;return 18<=a&&25>=a?8:28===a||32===a||46===a||47===a||51===a||55===a?10:9})(d);for(let h=0;h<f.length;h++)a.fillText(f[h],b.x*c,b.y*c+d+g+h*(d+e))}}return{Text:c}},function(){let a=e(0),{Graphic:b}=e(1);class g extends b{constructor(a,b){super(a,b),this.cursor='crosshair'}onOpen(b,c,d){let h=null;this.onmousedown=(b,c)=>{h={cmd:a.ELLIPSE,zoom:1,color:this.color,size:this.size,x:b,y:c,width:0,height:0}},this.onmousemove=(a,b,i)=>{if(null!==h){let e=a-h.x,j=b-h.y;i.shiftKey?h.width=h.height=f(e,j):(h.width=e,h.height=j),d.clear(!1),g.Draw(c,h,d.ratio)}},this.onmouseup=()=>{null!==h&&(d.clear(!1),g.Draw(b,h,d.ratio),d.change(h),h=null)}}onClose(){}static Draw(e,f,g){g*=f.zoom,e.strokeStyle=f.color,e.lineWidth=f.size*g;let h=f.x*g,i=f.y*g,j=f.width*g,k=f.height*g,l=j/2,m=k/2;0>l&&(h+=f.width,l=d(l)),0>m&&(i+=f.height,m=d(m));let n=l>m?l:m,o=l/n,p=m/n;e.save(),e.scale(o,p),e.beginPath(),e.arc((h+l)/o,(i+m)/p,n,0,2*c),e.closePath(),e.restore(),e.stroke()}}return{Ellipse:g}},function(){var a=Math.sin,b=Math.cos;let c=e(0),{Graphic:d}=e(1);class f extends d{onOpen(a,b,d){let e=null;this.onmousedown=(a,b)=>{e={cmd:c.ARROW,zoom:1,color:this.color,size:this.size,x1:a,y1:b,x2:a,y2:b}},this.onmousemove=(a,c)=>{null!==e&&(e.x2=a,e.y2=c,d.clear(!1),f.Draw(b,e,d.ratio))},this.onmouseup=()=>{null!==e&&(d.clear(!1),f.Draw(a,e,d.ratio),d.change(e),e=null)}}onClose(){}static paintArrow(c,d,e){let f=function(c,d){let e=b(d),f=a(d);return{x:c.x*e+c.y*f,y:c.y*e-c.x*f}};e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(d.x,d.y);let g=function(a,b){let c=Math.atan((b.x-a.x)/(b.y-a.y)),d=f(b,-c),e=f(a,-c),g=d.y-e.y,h=g*.5,i=d.y-g*1;return{h1:f({x:d.x+h,y:i},c),h2:f({x:d.x-h,y:i},c)}}(c,d,e);e.moveTo(g.h1.x,g.h1.y),e.lineTo(d.x,d.y),e.lineTo(g.h2.x,g.h2.y),e.stroke()}static Draw(c,d,e){e*=d.zoom,c.strokeStyle=d.color,c.lineWidth=d.size*e;let f=d.x1*e,g=d.y1*e,h=d.x2*e,i=d.y2*e;c.beginPath(),c.moveTo(f,g),c.lineTo(h,i),c.stroke();let j=Math.atan2(i-g,h-f),k=h-15*b(j),l=i-15*a(j);this.paintArrow({x:k,y:l},{x:h,y:i},c)}}return{Arrow:f}},function(){let a=e(0),{Graphic:b}=e(1);class c extends b{constructor(a){super(a)}onOpen(b,d,e){let f=null;this.onmousedown=(b,c)=>{f={cmd:a.MOSAIC,zoom:1,color:this.color,size:this.size,points:[{x:b,y:c}]}},this.onmousemove=(a,d)=>{if(null!==f){f.points.push({x:a,y:d});let g=f.points.length;c.Draw(b,f,e.ratio,2===g?0:g-1)}},this.onmouseup=()=>{null!==f&&(e.change(f),f=null)},c.MosaicCache=this.render(e.viewlayer.getContext('2d'),e.viewlayer.width,e.viewlayer.height)}onClose(){}render(a,b,c){let d=b,e=c,h=a.getImageData(0,0,d,e).data,i=document.createElement('canvas');i.width=d,i.height=e;let j,k,l,m,n,o,p,q,r,s,t=i.getContext('2d'),u=14,v=u/2;for(j=0;j<e/u+1;j++)for(m=(j-.5)*u,n=f(g(m,e-1),0),k=0;k<d/u+1;k++)l=(k-.5)*u,o=f(g(l,d-1),0),p=4*(o+n*d),q=h[p],r=h[p+1],s=h[p+2],t.fillStyle='rgb('+q+','+r+','+s+')',t.fillRect(l-v,m-v,u,u);return{width:d,height:e,data:t.getImageData(0,0,d,e).data}}static setData(a,b,c,d){let{width:e,data:f}=this.MosaicCache,h=4*e,i=a.length;for(let e=0;e<d;e++){let j=c*h+4*b+e*h,k=g(j+4*d,i-1);if(j>=i)break;a.set(f.subarray(j,k),j)}}static Draw(a,b,c,e=0){var j=Math.round,k=Math.pow;c*=b.zoom;let h=b.points,l=h.length,i=this.MosaicCache,m=new Uint8ClampedArray(i.data.length),n=4*(b.size*c);for(let o=e;o<l;o++){let a=h[o],e=a.x*c,i=a.y*c;if(0===o)this.setData(m,f(g(e,e-n),0),i,n);else{let a=b.points[o-1],l=a.x*c,p=a.y*c,q=n-1,r=n-1,s=e-l,t=i-p,u=0===s?0:1,w=Math.sqrt(k(s,2)+k(t,2)),x=parseInt(w/(r>q?q:r));3>x&&(x=3*x+1);let y=d(t)/x*(i<p?-1:1),v=d(s)/x*(e<l?-1:1);for(let c=0;c<x;c++){let d=j(v*c*u+l),a=j(y*c+p);this.setData(m,f(g(d,d-n),0),a,n)}}}let o=new ImageData(m,i.width,i.height),p=document.createElement('canvas');p.width=i.width,p.height=i.height,p.getContext('2d').putImageData(o,0,0),a.drawImage(p,0,0)}}return{Mosaic:c}},function(){return{Tool:class{constructor(a,b,c,d=0,e=0){this.id='SPGraphic'+a,this.width=b,this.height=c,this.board=null,this.dom=null,this.offsetX=d,this.offsetY=e}init(a,b){this.board=a;let c=document.createElement('div');c.id=this.id,c.style.position='absolute',c.style.zIndex='999999',c.style.display='none',this.dom=c,this.onInit(c),b.appendChild(c)}onCreate(){let a='number'!=typeof this.width;if(a){let a=this.dom;a.style.visibility='hidden',a.style.display='block',this.width=a.clientWidth,this.height=a.clientHeight,a.style.display='none',a.style.visibility=''}}onInit(){}setStyle(a){let b=this.dom;for(let c in a)a.hasOwnProperty(c)&&(b.style[c]=a[c])}setPosition(a,b){this.dom.style.left=a+this.offsetX+'px',this.dom.style.top=b+this.offsetY+'px'}show(){this.dom.style.display='block'}hide(){this.dom.style.display='none'}}}},function(){let{Tool:a}=e(8);return{CropMenu:class extends a{constructor(a){super('CropMenu',56,26,0,8),this.callback=a}onInit(a){this.setStyle({background:'#ffffff',textAlign:'center',lineHeight:'20px',cursor:'default',userSelect:'none',boxShadow:'0 0 7px 0 rgba(0, 0, 0, 0.5)',borderRadius:'2px'});let b=document.createElement('div');b.style.width='20px',b.style.height='20px',b.style.margin='3px 3px 3px 5px',b.style.float='left',b.innerText='\u2717';let c=document.createElement('div');c.style.width='20px',c.style.height='20px',c.style.margin='3px 5px 3px 3px',c.style.float='left',c.innerText='\u2713',c.onclick=()=>{this.callback(!0)},b.onclick=()=>{this.callback(!1)},a.appendChild(b),a.appendChild(c)}update(a){let{board:c,width:d,height:e}=this,g=c.dom,h=this.board.getBoardBounds(1,!1),b=a.x+a.width-d-h.x,i=a.y+a.height-h.y,j=g.offsetParent.clientHeight-g.offsetTop;i+e>j&&(i-=e+14,b-=6),this.setPosition(f(b,0),i)}show(a){this.update(a),super.show()}}}},function(){let{Tool:a}=e(8);return{CropPicker:class extends a{constructor(a){super('CropPicker',120,136,10,20),this.ctx=null,this.label=null,this.timer=null,this.max=null;let b=b=>parseInt(a.slice(b,b+2),16);this.color='rgba('+[b(1),b(3),b(5),.8].join(',')+')'}onInit(a){let{width:c,height:d,offsetX:e,offsetY:f}=this,g=this.height-36,i=this.board.ratio;this.setStyle({pointerEvents:'none',border:'1px solid #777777'});let j=document.createElement('canvas');j.style.height=g+'px',j.style.display='block',j.width=c*i,j.height=g*i;let k=document.createElement('div');k.style.height='30px',k.style.padding='3px',k.style.font='12px sans-serif',k.style.lineHeight='15px',k.style.background='rgba(0, 0, 0, 0.5)',k.style.color='#ffffff',k.innerHTML='RGB: (0,0,0)<br>POS: (0, 0)',a.appendChild(j),a.appendChild(k),this.ctx=j.getContext('2d'),this.label=k;let l=this.board.getBoardBounds(1);this.max={x:l.width-c-e,y:l.height-d-f,dx:c+2*e,dy:d+f+10};let m=b(21*i),h=m+b(6*i),n=0,o=0,p=b(86*i),q=b(12*i),r=b(p/2),s=b(m/2);this.updateSize=(a,b)=>{a.clearRect(n,o,p,m),n=b.x,o=b.y-h,0>o&&(n+=3,o=b.y+3),a.fillStyle='rgba(0, 0, 0, 0.5)',a.fillRect(n,o,p,m);let c=b.width+' x '+b.height;a.font=q+'px Arial',a.fillStyle='#ffffff',a.textAlign='center',a.textBaseline='middle',a.fillText(c,n+r,o+s)}}setInfo(a,b,c){this.label.innerHTML='RGB: ('+a[0]+','+a[1]+','+a[2]+')<br>POS: ('+b+', '+c+')'}update(a,b){let c=this.board,d=c.ratio,e=this.max,f=a,g=b;a>e.x&&(f=a-e.dx),b>e.y&&(g=b-e.dy),this.setPosition(f,g),clearTimeout(this.timer),this.timer=setTimeout(()=>{let e=this.ctx;e.imageSmoothingEnabled=!1,e.drawImage(c.viewlayer,(a-14.5)*d,(b-12)*d,30*d,25*d,0,0,120*d,100*d),e.moveTo(60*d,0),e.lineTo(60*d,100*d),e.moveTo(0,50*d),e.lineTo(120*d,50*d),e.lineWidth=4,e.strokeStyle=this.color,e.stroke();let f=e.getImageData(60,50,1,1).data;this.setInfo(f,a,b)})}show(a,b){this.update(a,b),super.show()}}}},function(){let a={};return a={Move:'move',Right:'e',Left:'w',Top:'n',Bottom:'s',LeftTop:'nw',RightTop:'ne',RightBottom:'se',LeftBottom:'sw',get(a,b,c){let d=5,e=a-c.x,f=b-c.y,g=c.width,h=c.height,i=null;return e>=-d&&e<=g+d&&f>=-d&&f<=h+d&&(i='',5>=f&&(i=this.Top),f>=h-5&&(i=this.Bottom),5>=e&&(i+=this.Left),e>=g-5&&(i+=this.Right),''===i&&(i=this.Move)),i},cursor(a){return null===a?'':'move'===a?'move':a+'-resize'}},a},function(){let a=e(0),{Graphic:d}=e(1),{CropMenu:h}=e(9),{CropPicker:i}=e(10),j=e(11);class k extends d{constructor(a,b){super(),this.keep=!1,this.ctx=null,this.menu=a?a:null,this.picker=null,this.blocks=b||[],this.onCancel=null,this.onConfirm=null,this.region={normal:{},mach:{}}}init(a){let c=document.createElement('canvas');c.style.position='absolute',c.style.pointerEvents='none',c.style.width='100%',c.style.height='100%',c.width=a.draftlayer.width,c.height=a.draftlayer.height,a.wrap.appendChild(c),this.ctx=c.getContext('2d');let d=document.createElement('div');d.style.position='absolute',d.style.width='100%',d.style.height='100%',d.style.top='0',null===this.menu&&(this.menu=new h(b=>{this.triggerCallback(a,b)})),this.menu.init(a,d),this.keep&&(this.picker=new i(this.color),this.picker.init(a,d)),a.dom.appendChild(d),this.menu.onCreate();let{x:e,y:f,width:g,height:j}=this.region.normal=a.getBoardBounds(1),k=a.ratio;this.region.mach={x:e*k,y:f*k,width:g*k,height:j*k};let l={x:0,y:0,width:0,height:0},m=!this.keep;if(m){let a=.8*g,c=.8*j;l.width=b(a),l.height=b(c),l.x=b(e+g/2-a/2),l.y=b(f+j/2-c/2),this.menu.show(l)}return this.render(a.draftctx,l,a.ratio,m),l}onOpen(a,b,c){let d=null,e={x:0,y:0},h=null,i=this.keep,k=this.init(c),l=0,m=a=>{c.setCursor(j.cursor(a))},n=()=>{h=c.getBoardBounds(1),h.width+=h.x-k.width,h.height+=h.y-k.height},o=({x:a,y:b,width:c,height:d})=>(0>c&&(a+=c,c=-c),0>d&&(b+=d,d=-d),{x:a,y:b,width:c,height:d}),p=({x:c,y:d,width:e,height:f})=>{b.save(),a.save(),b.beginPath(),b.rect(c,d,e,f),b.clip(),a.beginPath(),a.rect(c,d,e,f),a.clip()};this.onmousedown=(a,b)=>{d=j.get(a,b,k),m(d),e.x=a-k.x,e.y=b-k.y,this.menu.hide(),n(),c.restore(),i&&null!==d&&'move'!==d&&this.picker.show(a,b)};let q=(a,l)=>{null===d?m(j.get(a,l,k)):'move'===d?(k.x=g(f(a-e.x,h.x),h.width),k.y=g(f(l-e.y,h.y),h.height),this.render(b,k,c.ratio)):(-1===d.indexOf(j.Right)?-1!==d.indexOf(j.Left)&&(k.width=k.x+k.width-a,k.x=a):k.width=a-k.x,-1===d.indexOf(j.Top)?-1!==d.indexOf(j.Bottom)&&(k.height=l-k.y):(k.height=k.y+k.height-l,k.y=l),this.render(b,o(k),c.ratio),i&&this.picker.update(a,l))};this.onmousemove=i?(a,f)=>{null===h?this.checkBlocks(b,a,f,c.ratio):2>l?l++:(d=j.RightBottom,k.x=e.x+k.x,k.y=e.y+k.y,e.x=0,e.y=0,q(a,f),this.onmousemove=q),this.picker.update(a,f)}:q,this.onmouseup=()=>{i&&null!==h&&p(this.region.mach),2>=l&&(k=Object.assign({},this.region.normal),this.render(b,k,c.ratio),this.onmousemove=q),d=null,h=null,e={x:0,y:0},c.setCursor(this.cursor),this.menu.show(k),i&&this.picker.hide()}}onClose(a){this.restore(a),a.wrap.removeChild(this.ctx.canvas),this.blocks=[]}restore(a){a.clear(!1),a.restore(),this.menu.hide(),this.keep&&this.picker.hide()}triggerCallback(b,c){let d=this.onCancel;if(c){d=this.onConfirm;let c=Object.assign({cmd:a.CROP,zoom:1},this.region.normal);k.Draw(b.viewctx,c,b.ratio,b),b.change(c)}b.restore(),b.deselect(),'function'==typeof d&&d()}showPicker(a,b){this.onmousemove(a,b),this.picker.show(a,b)}getBounds(a){return Object.assign({},1===a?this.region.normal:this.region.mach)}checkBlocks(a,c,d,e){if(this.keep)for(let f of this.blocks)if(c>=f.left&&c<=f.left+f.width&&d>=f.top&&d<=f.top+f.height){this.render(a,{x:f.left,y:f.top,width:f.width,height:f.height},e,!1);break}}render(a,{x:c,y:d,width:e,height:f},g,h=!0){let i=this.region.mach,j=b(c*g),k=b(d*g),l=b(e*g),m=b(f*g),n=i.x,o=i.y,p=i.width,q=i.height;a.fillStyle='rgba(0,0,0,0.7)',a.fillRect(n,o,p,q);let r=n-5,s=o-5,t=p+10,u=q+10;this.ctx.clearRect(r,s,10,u),this.ctx.clearRect(r,s,t,10),this.ctx.clearRect(r+p,s,10,u),this.ctx.clearRect(r,s+q,t,10),this.region={mach:{x:j,y:k,width:l,height:m},normal:{x:c,y:d,width:e,height:f}},a.clearRect(j,k,l,m),this.keep&&this.picker.updateSize(this.ctx,this.region.mach),this.renderBorder(j,k,l,m,g,h)}renderBorder(a,b,d,e,f,g){let h=this.ctx;if(h.strokeStyle=this.color,h.lineWidth=this.size*f,h.strokeRect(a,b,d,e),g){let f=5,g=3,i=(d,a)=>{h.beginPath(),h.fillStyle=this.color,h.arc(d,a,f,0,f*c),h.fill(),h.beginPath(),h.fillStyle='#ffffff',h.arc(d,a,g,0,g*c),h.fill()},j=a,k=j+d/2,l=j+d,m=b,n=m+e/2,o=m+e;i(j,m),i(k,m),i(l,m),i(j,n),i(l,n),i(j,o),i(k,o),i(l,o)}}static Draw(a,b,c,d){c=b.zoom,d.setBounds(-b.x*c,-b.y*c,b.width*c,b.height*c)}}return{Crop:k}},function(){let a={};return a=function(a){let b=null,c=null,d=d=>{if(a.contains(d.target)){let e=a.clientWidth,f=a.clientHeight,g=a.offsetParent,h=g.clientWidth,i=g.clientHeight;e>h&&(b={min:a.offsetLeft-d.pageX,max:h-e}),f>i&&(c={min:a.offsetTop-d.pageY,max:i-f})}},e=d=>{null!==b&&(a.style.left=g(f(b.min+d.pageX,b.max),0)+'px',a.style.right='auto'),null!==c&&(a.style.top=g(f(c.min+d.pageY,c.max),0)+'px',a.style.bottom='auto')},h=()=>{b=null,c=null};return{enabled:!1,enable:()=>{this.enabled||(this.enabled=!0,window.addEventListener('mousedown',d,!0),window.addEventListener('mousemove',e,!0),window.addEventListener('mouseup',h,!0))},disable:()=>{this.enabled=!1,window.removeEventListener('mousedown',d,!0),window.removeEventListener('mousemove',e,!0),window.removeEventListener('mouseup',h,!0)},center:(b,c)=>{let d=a.offsetParent,e=a.offsetLeft,f=a.offsetTop,h=a.clientWidth,i=a.clientHeight,j=d.clientWidth,k=d.clientHeight;h>j?(e-=b/2,e+h<j&&(e=j-h),a.style.left=g(e,0)+'px',a.style.right='auto'):(a.style.left='0',a.style.right='0'),i>k?(f-=c/2,f+i<k&&(f=k-i),a.style.top=g(f,0)+'px',a.style.bottom='auto'):(a.style.top='0',a.style.bottom='0')}}},a}];a.SPGraphic=function(){let a={},{Pen:c}=e(2),{Rect:h}=e(3),{Text:i}=e(4),{Ellipse:j}=e(5),{Arrow:k}=e(6),{Mosaic:l}=e(7),{Crop:m}=e(12),{CropMenu:n}=e(9),o=e(0),p=e(13);class q{constructor(a,b){this.entity=null,this.ratio=window.devicePixelRatio,this.zoom=b.zoom,this.ts=null,this.record=[],this.status={w1:0,h1:0,w2:0,h2:0,scale:1},this.enableKeepCrop=b.keepCrop instanceof m,this.keepCrop=b.keepCrop,this.dom=this._initBoard(a,b),this._initCanvas(this.ratio),this._initEvents(this.draftlayer),this.enableKeepCrop&&(this.keepCrop.keep=!0,this.keepCrop.open(this),this.setCursor(this.keepCrop.cursor))}_initBoard(a,b){if(b.enableTouchScroll){let{width:c,height:d}=b,e=document.createElement('div');return e.style.width='number'==typeof c?c+'px':c,e.style.height='number'==typeof d?d+'px':d,e.style.position='absolute',e.style.left='0',e.style.right='0',e.style.top='0',e.style.bottom='0',e.style.margin='auto',a.appendChild(e),this.ts=p(e),this.ts.enable(),e}return a}_initCanvas(a){let b=this.dom,c=b.clientWidth,d=b.clientHeight;this.status={w1:c,h1:d,w2:c,h2:d,scale:1};let e=document.createElement('div'),f=document.createElement('div'),g=document.createElement('canvas'),h=document.createElement('canvas');e.style.overflow='hidden',e.style.zIndex='1',e.style.position=f.style.position=g.style.position=h.style.position='absolute',f.style.width=c+'px',f.style.height=d+'px',e.style.width=g.style.width=h.style.width='100%',e.style.height=g.style.height=h.style.height='100%',e.style.top=f.style.top=g.style.top=h.style.top='0',f.style.left='0',g.width=h.width=c*a,g.height=h.height=d*a,this.container=e,this.wrap=f,this.viewlayer=g,this.draftlayer=h,this.viewctx=g.getContext('2d'),this.draftctx=h.getContext('2d'),f.appendChild(g),f.appendChild(h),e.appendChild(f),b.appendChild(e)}_initEvents(a){let c=null,d=null,h=(a,h,e=!1)=>{let i=this.entity||this.keepCrop;if(null!==i){let j=h.offsetX,k=h.offsetY;e&&(j=f(g(h.pageX-c.left,d.width),d.x),k=f(g(h.pageY-c.top,d.height),d.y)),i.triggerEvent(a,b(j),b(k),h)}};this.enableKeepCrop?(this.onmousedown_event=f=>{if(f.target===a){let e=a.getBoundingClientRect(),g=null===this.entity?this.getBoardBounds(1):this.keepCrop.getBounds(1);g.width+=g.x,g.height+=g.y;let b=f.pageX-e.left,i=f.pageY-e.top;(null===this.entity||b>=g.x&&b<=g.width&&i>=g.y&&i<=g.height)&&(c=e,d=g,h('onmousedown',f))}},this.onmousemove_event=b=>{h('onmousemove',b,null!==c&&(null!==this.entity||b.target!==a))}):(this.onmousedown_event=b=>{b.target===a&&(c=a.getBoundingClientRect(),d=this.getBounds(1),d.width+=d.x,d.height+=d.y,h('onmousedown',b))},this.onmousemove_event=b=>{b.target===a?h('onmousemove',b):null!==c&&h('onmousemove',b,!0)}),this.onmouseup_event=a=>{null!==c&&(h('onmouseup',a,!0),c=null,d=null)},window.addEventListener('mousedown',this.onmousedown_event,!0),window.addEventListener('mousemove',this.onmousemove_event,!0),window.addEventListener('mouseup',this.onmouseup_event,!0)}_removeEvents(){window.removeEventListener('mousedown',this.onmousedown_event,!0),window.removeEventListener('mousemove',this.onmousemove_event,!0),window.removeEventListener('mouseup',this.onmouseup_event,!0)}setCursor(a){this.draftlayer.style.cursor=a}dispose(){this.deselect(),this._removeEvents(),null===this.ts?this.dom.removeChild(this.container):this.dom.parentElement.removeChild(this.dom),null!==this.keepCrop&&(this.keepCrop.close(this),this.keepCrop=null),this.record=[]}select(a){this.deselect(),null!==this.ts&&this.ts.disable(),this.entity=a,this.entity.open(this),this.setCursor(a.cursor)}deselect(){null!==this.entity&&(null!==this.ts&&this.ts.enable(),this.entity.close(this),this.entity=null,this.setCursor(''))}setZoom(a){this.zoom=a}_updateZoom(a){this.status.scale+=a,this.zoom+=a;let{scale:b,w1:c,w2:d,h1:e,h2:f}=this.status,g=this.dom,h=this.wrap,i=this.viewlayer,j=this.draftlayer,k=this.ratio,l=g.clientWidth,m=g.clientHeight;c*=b,e*=b,g.style.width=d*b+'px',g.style.height=f*b+'px',h.style.width=c+'px',h.style.height=e+'px',i.width=j.width=c*k,i.height=j.height=e*k,this.load(this.record,1,!1),null!==this.entity&&this.entity.restore(this),null!==this.ts&&this.ts.center(g.clientWidth-l,g.clientHeight-m)}zoomIn(a){this._updateZoom(a)}zoomOut(a){this._updateZoom(-a)}setImage(a,b=!0){let c=b=>{b&&a.removeEventListener('load',c,!0),this.viewctx.drawImage(a,0,0,this.viewlayer.width,this.viewlayer.height)};a instanceof ImageData?this.viewctx.putImageData(a,0,0):a.complete?c():a.addEventListener('load',c,!0),b&&this.record.push({cmd:o.IMAGE,value:a})}undo(a=!0){this._clear(),this.record.pop(),this.setBounds(0,0,this.wrap.clientWidth,this.wrap.clientHeight),0<this.record.length&&this.load(this.record,1,!1),a&&this.onchange({cmd:o.UNDO})}load(a,b=1,d=!0){for(let e of a){let a=this.ratio,f=e.zoom/b;switch(e.zoom=this.status.scale/f,e.cmd){case o.PEN:c.Draw(this.viewctx,e,a),d&&this.record.push(e);break;case o.RECT:h.Draw(this.viewctx,e,a),d&&this.record.push(e);break;case o.TEXT:i.Draw(this.viewctx,e,a),d&&this.record.push(e);break;case o.ELLIPSE:j.Draw(this.viewctx,e,a),d&&this.record.push(e);break;case o.ARROW:k.Draw(this.viewctx,e,a),d&&this.record.push(e);break;case o.MOSAIC:l.Draw(this.viewctx,e,a),d&&this.record.push(e);break;case o.CROP:m.Draw(this.viewctx,e,a,this),d&&this.record.push(e);break;case o.IMAGE:this.setImage(e.value,!1),d&&this.record.push(e);break;case o.CLEAR:this.clear();break;case o.UNDO:this.undo(!1);}e.zoom=f}}change(a){a.zoom=this.zoom,this.record.push(a),this.onchange(a)}onchange(){}setBounds(a,b,c,d){let e=this.dom,f=e.clientWidth,g=e.clientHeight;(f!==c||g!==d)&&(e.style.width=c+'px',e.style.height=d+'px',this.status.w2=c,this.status.h2=d,this.wrap.style.left=a+'px',this.wrap.style.top=b+'px',null!==this.ts&&this.ts.center(f-c,g-d))}getBounds(a=this.ratio,b=!0){return this.enableKeepCrop?this.keepCrop.getBounds(a,null===this.entity?0:this.entity.size):this.getBoardBounds(a,b)}getBoardBounds(a=this.ratio,c=!0){let e=this.dom,f=this.wrap.offsetLeft,g=this.wrap.offsetTop,h=e.clientWidth,i=e.clientHeight;if(c&&null!==this.ts){let a=this.dom.offsetLeft,b=this.dom.offsetTop,c=this.dom.offsetParent;0>=a&&(f-=a,h=c.clientWidth),0>=b&&(g-=b,i=c.clientHeight)}return{x:b(d(f)*a),y:b(d(g)*a),width:b(h*a),height:b(i*a)}}restore(){this.draftctx.restore(),this.viewctx.restore()}_clear(){let{width:a,height:b}=this.viewlayer;this.draftctx.clearRect(0,0,a,b),this.viewctx.clearRect(0,0,a,b),this.entity instanceof m&&this.deselect()}clear(a=!0){if(a)this.record=[],this._clear(),this.onchange({cmd:o.CLEAR});else{let{width:a,height:b}=this.viewlayer;if(this.enableKeepCrop){let a=this.keepCrop.getBounds(this.ratio);this.draftctx.clearRect(a.x,a.y,a.width,a.height)}else this.draftctx.clearRect(0,0,a,b)}}save(a=!0,b=.8){let c=this.getBounds(),d=document.createElement('canvas');d.width=c.width,d.height=c.height,d.getContext('2d').drawImage(this.viewlayer,-c.x,-c.y,this.viewlayer.width,this.viewlayer.height);let e=d.toDataURL('image/jpeg',b);return a?e:e.replace(/^data:image\/\w+;base64,/,'')}}return a={create(a,b={}){'number'==typeof b&&(b={zoom:b});let c={zoom:1,enableTouchScroll:!1,keepCrop:null,width:'100%',height:'100%'};if(b)for(let a in c)b.hasOwnProperty(a)&&(c[a]=b[a]);return new q(a,c)},Pen:c,Rect:h,Text:i,Ellipse:j,Arrow:k,Mosaic:l,Crop:m,CropMenu:n,GraphicType:o},a}()})(window);